name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PHP_VERSION: '8.4'
  NODE_VERSION: '22'

jobs:
  # ============================================
  # Lint Backend
  # ============================================
  lint-backend:
    name: ğŸ” Lint Backend (PHPStan)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: pdo_pgsql, intl, zip
          coverage: none

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: backend/vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('backend/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Setup environment file
        working-directory: backend
        run: cp .env.example .env

      - name: Install dependencies
        working-directory: backend
        run: composer install --prefer-dist --no-progress

      - name: Run PHPStan
        working-directory: backend
        run: vendor/bin/phpstan analyse src --level=5 --no-progress

  # ============================================
  # Lint Frontend
  # ============================================
  lint-frontend:
    name: ğŸ” Lint Frontend (ESLint)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run ESLint
        working-directory: frontend
        run: npm run lint

  # ============================================
  # Tests Backend
  # ============================================
  test-backend:
    name: ğŸ§ª Tests Backend (PHPUnit)
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: defi_fullstack_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: pdo_pgsql, intl, zip
          coverage: xdebug

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: backend/vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('backend/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Setup environment file
        working-directory: backend
        run: |
          if [ ! -f .env ]; then
            cp .env.example .env
            echo "âœ… .env crÃ©Ã© depuis .env.example"
          fi

      - name: Install dependencies
        working-directory: backend
        run: composer install --prefer-dist --no-progress

      - name: Create .env.test
        working-directory: backend
        run: |
          cat > .env.test << EOF
          APP_ENV=test
          DATABASE_URL="postgresql://test_user:test_password@localhost:5432/defi_fullstack_test?serverVersion=16&charset=utf8"
          EOF

      - name: Run migrations
        working-directory: backend
        run: php bin/console doctrine:migrations:migrate --no-interaction --env=test

      - name: Run tests with coverage
        working-directory: backend
        run: php bin/phpunit --coverage-clover coverage.xml --coverage-text

      - name: Upload coverage to Codecov (optionnel)
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage.xml
          flags: backend
          fail_ci_if_error: false

  # ============================================
  # Tests Frontend
  # ============================================
  test-frontend:
    name: ğŸ§ª Tests Frontend (Vitest)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run tests with coverage
        working-directory: frontend
        run: npm run test -- --coverage

      - name: Upload coverage to Codecov (optionnel)
        uses: codecov/codecov-action@v4
        with:
          files: ./frontend/coverage/coverage-final.json
          flags: frontend
          fail_ci_if_error: false

  # ============================================
  # Security Checks
  # ============================================
  security:
    name: ğŸ”’ Security Checks
    runs-on: ubuntu-latest
    needs: [lint-backend, lint-frontend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup backend environment
        working-directory: backend
        run: cp .env.example .env

      - name: Install backend dependencies
        working-directory: backend
        run: composer install --prefer-dist --no-progress

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Check Composer vulnerabilities
        working-directory: backend
        run: composer audit || true

      - name: Check npm vulnerabilities
        working-directory: frontend
        run: npm audit --audit-level=high || true

      - name: Install Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy

      - name: Run Trivy vulnerability scanner
        run: trivy fs --severity HIGH,CRITICAL --exit-code 0 --format table .

  # ============================================
  # Build Docker Images
  # ============================================
  build:
    name: ğŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, security]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: false
          tags: defi-fullstack-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: Build frontend image (prod)
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          target: production
          push: false
          tags: defi-fullstack-frontend:prod
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test docker-compose build
        run: docker compose build

  # ============================================
  # Summary
  # ============================================
  ci-success:
    name: âœ… CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [build]
    if: success()
    
    steps:
      - name: Success message
        run: |
          echo "ğŸ‰ All CI checks passed successfully!"
          echo "âœ… Lint: Backend & Frontend"
          echo "âœ… Tests: Backend & Frontend"
          echo "âœ… Security: Composer, npm, Trivy"
          echo "âœ… Build: Docker images"